#!/usr/bin/env node

import { spawn } from "node:child_process";
import { existsSync } from "node:fs";
import { dirname, join } from "node:path";
import { fileURLToPath } from "node:url";

const __filename = fileURLToPath(import.meta.url);
const binDir = dirname(__filename);
const platform = process.platform;
const arch = process.arch;

// Map Node.js platform/arch to our binary names
const platformMap = {
	darwin: "darwin",
	linux: "linux",
	win32: "windows",
};

const archMap = {
	arm64: "arm64",
	x64: "x64",
};

const os = platformMap[platform];
const cpu = archMap[arch];

if (!os || !cpu) {
	console.error(`Unsupported platform: ${platform}-${arch}`);
	process.exit(1);
}

const binaryName = `toolui-${os}-${cpu}${platform === "win32" ? ".exe" : ""}`;
const binaryPath = join(binDir, binaryName);

if (!existsSync(binaryPath)) {
	console.error(`Binary not found: ${binaryPath}`);
	console.error(
		"This may happen if the postinstall script failed to download the binary.",
	);
	console.error("Try reinstalling: npm install -g toolui");
	process.exit(1);
}

// Execute the binary with all arguments passed through
const child = spawn(binaryPath, process.argv.slice(2), {
	stdio: "inherit",
	windowsHide: true,
});

child.on("error", (err) => {
	console.error(`Failed to start toolui: ${err.message}`);
	process.exit(1);
});

child.on("exit", (code, signal) => {
	if (signal) {
		process.kill(process.pid, signal);
	} else {
		process.exit(code ?? 0);
	}
});
